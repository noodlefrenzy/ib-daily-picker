# GitHub Actions workflow for building and deploying to Azure Container Apps
name: Build and Deploy

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AZURE_RESOURCE_GROUP: ib-picker-rg
  AZURE_LOCATION: eastus
  IMAGE_NAME: ibpicker-bot

jobs:
  # Build and test
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run linting
        run: |
          ruff check .
          mypy src/

      - name: Run tests
        run: pytest --tb=short

  # Build and push Docker image
  docker:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR login server
        id: acr
        run: |
          ACR_LOGIN_SERVER=$(az acr list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "[0].loginServer" -o tsv)
          echo "login-server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT

      - name: Log in to ACR
        run: |
          az acr login --name $(echo ${{ steps.acr.outputs.login-server }} | cut -d'.' -f1)

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.acr.outputs.login-server }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # Deploy to Azure Container Apps
  deploy:
    needs: docker
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
          template: ./infra/main.bicep
          parameters: environment=${{ github.event.inputs.environment || 'dev' }}
          deploymentMode: Incremental

      - name: Get Container App name
        id: app
        run: |
          ENV=${{ github.event.inputs.environment || 'dev' }}
          SUFFIX=""
          if [ "$ENV" != "prod" ]; then
            SUFFIX="-$ENV"
          fi
          echo "name=ibpicker-bot$SUFFIX" >> $GITHUB_OUTPUT

      - name: Update Container App image
        run: |
          az containerapp update \
            --name ${{ steps.app.outputs.name }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image $(echo "${{ needs.docker.outputs.image-tag }}" | head -n1)

      - name: Configure secrets from Key Vault
        run: |
          # Get Key Vault name
          KV_NAME=$(az keyvault list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "[0].name" -o tsv)

          # Update container app with Key Vault references
          # Note: Secrets must be pre-populated in Key Vault
          az containerapp secret set \
            --name ${{ steps.app.outputs.name }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --secrets discord-token=keyvaultref:${KV_NAME}:discord-token \
                      uw-api-key=keyvaultref:${KV_NAME}:uw-api-key \
            || echo "Secrets may not exist yet - configure them in Key Vault"

  # Notify on deployment
  notify:
    needs: [build, docker, deploy]
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "Deployment successful!"
          else
            echo "Deployment failed or skipped"
            exit 1
          fi
