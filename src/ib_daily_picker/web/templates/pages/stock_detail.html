{% extends "base.html" %}

{% block title %}{{ symbol }} - IB Daily Picker{% endblock %}

{% block head_scripts %}
<!-- TradingView Lightweight Charts -->
<script src="/static/vendor/lightweight-charts.standalone.production.js"></script>
{% endblock %}

{% block content %}
<div class="stock-detail">
    <!-- Header -->
    <div class="stock-header">
        <div class="stock-title">
            <h1>{{ symbol }}</h1>
            {% if metadata and metadata.name %}
            <span class="stock-name">{{ metadata.name }}</span>
            {% endif %}
        </div>
        <div class="stock-actions">
            <a href="/charts/compare?symbols={{ symbol }}" class="btn btn-secondary">Compare</a>
            {% if in_watchlist %}
            <button class="btn btn-secondary"
                    hx-delete="/api/watchlist/{{ symbol }}"
                    hx-swap="outerHTML"
                    hx-target="closest button">
                Remove from Watchlist
            </button>
            {% else %}
            <button class="btn btn-primary"
                    hx-post="/api/watchlist"
                    hx-vals='{"symbol": "{{ symbol }}"}'
                    hx-swap="outerHTML"
                    hx-target="closest button">
                Add to Watchlist
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Stats Row -->
    <section class="card">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">${{ "%.2f"|format(stats.latest_close) }}</div>
                <div class="stat-label">Last Close</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ "{:,}".format(stats.volume) }}</div>
                <div class="stat-label">Volume</div>
            </div>
            {% if stats.high_52w %}
            <div class="stat-card">
                <div class="stat-value">${{ "%.2f"|format(stats.high_52w) }}</div>
                <div class="stat-label">52W High</div>
            </div>
            {% endif %}
            {% if stats.low_52w %}
            <div class="stat-card">
                <div class="stat-value">${{ "%.2f"|format(stats.low_52w) }}</div>
                <div class="stat-label">52W Low</div>
            </div>
            {% endif %}
            {% if metadata and metadata.sector %}
            <div class="stat-card">
                <div class="stat-value">{{ metadata.sector }}</div>
                <div class="stat-label">Sector</div>
            </div>
            {% endif %}
            <div class="stat-card">
                <div class="stat-value">{{ stats.data_points }}</div>
                <div class="stat-label">Data Points</div>
            </div>
        </div>
    </section>

    <!-- Chart Controls -->
    <section class="card">
        <div class="chart-controls">
            <h2>Price Chart</h2>
            <div class="indicator-toggles">
                <label class="toggle-label">
                    <input type="checkbox" id="toggle-sma50" checked> SMA 50
                </label>
                <label class="toggle-label">
                    <input type="checkbox" id="toggle-sma200" checked> SMA 200
                </label>
                <label class="toggle-label">
                    <input type="checkbox" id="toggle-volume" checked> Volume
                </label>
                <label class="toggle-label">
                    <input type="checkbox" id="toggle-markers" checked> Flow Alerts
                </label>
            </div>
        </div>
        <div id="price-chart" style="height: 400px;"></div>
        <div id="volume-chart" style="height: 100px;"></div>
        <div class="chart-legend">
            <span class="legend-item"><span class="legend-color" style="background: #ffaa00;"></span> SMA 50</span>
            <span class="legend-item"><span class="legend-color" style="background: #00aaff;"></span> SMA 200</span>
            <span class="legend-item"><span class="legend-color" style="background: #00c853;"></span> Bullish Alert</span>
            <span class="legend-item"><span class="legend-color" style="background: #ff5252;"></span> Bearish Alert</span>
        </div>
    </section>

    <!-- Flow Alerts -->
    {% if flow_alerts %}
    <section class="card">
        <h2>Flow Alerts ({{ flow_alerts|length }})</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Type</th>
                    <th>Direction</th>
                    <th>Premium</th>
                    <th>Strike</th>
                    <th>Expiration</th>
                    <th>Sentiment</th>
                </tr>
            </thead>
            <tbody>
                {% for alert in flow_alerts %}
                <tr>
                    <td class="timestamp">{{ alert.alert_time.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>{{ alert.alert_type.value }}</td>
                    <td class="{% if alert.direction.value == 'bullish' %}positive{% elif alert.direction.value == 'bearish' %}negative{% endif %}">
                        {{ alert.direction.value|upper }}
                    </td>
                    <td>{% if alert.premium %}${{ "{:,.0f}".format(alert.premium) }}{% else %}-{% endif %}</td>
                    <td>{% if alert.strike %}${{ "%.2f"|format(alert.strike) }}{% else %}-{% endif %}</td>
                    <td>{% if alert.expiration %}{{ alert.expiration }}{% else %}-{% endif %}</td>
                    <td class="{% if alert.sentiment.value == 'bullish' %}positive{% elif alert.sentiment.value == 'bearish' %}negative{% endif %}">
                        {{ alert.sentiment.value }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Chart data from server
    const chartData = {{ chart_data | tojson }};
    const indicatorData = {{ indicator_data | tojson }};
    const flowMarkers = {{ flow_markers | tojson }};

    // Chart containers
    const priceContainer = document.getElementById('price-chart');
    const volumeContainer = document.getElementById('volume-chart');

    // Create main price chart
    const priceChart = LightweightCharts.createChart(priceContainer, {
        width: priceContainer.clientWidth,
        height: 400,
        layout: {
            background: { type: 'solid', color: '#16213e' },
            textColor: '#e8e8e8',
        },
        grid: {
            vertLines: { color: '#2d2d44' },
            horzLines: { color: '#2d2d44' },
        },
        crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
        },
        rightPriceScale: {
            borderColor: '#2d2d44',
        },
        timeScale: {
            borderColor: '#2d2d44',
            timeVisible: true,
        },
    });

    // Create volume chart (separate pane)
    const volumeChart = LightweightCharts.createChart(volumeContainer, {
        width: volumeContainer.clientWidth,
        height: 100,
        layout: {
            background: { type: 'solid', color: '#16213e' },
            textColor: '#e8e8e8',
        },
        grid: {
            vertLines: { color: '#2d2d44' },
            horzLines: { visible: false },
        },
        rightPriceScale: {
            borderColor: '#2d2d44',
            scaleMargins: { top: 0.1, bottom: 0 },
        },
        timeScale: {
            visible: false,
        },
    });

    // Candlestick series
    const candlestickSeries = priceChart.addCandlestickSeries({
        upColor: '#00c853',
        downColor: '#ff5252',
        borderDownColor: '#ff5252',
        borderUpColor: '#00c853',
        wickDownColor: '#ff5252',
        wickUpColor: '#00c853',
    });
    candlestickSeries.setData(chartData);

    // Add flow alert markers to candlestick series
    if (flowMarkers && flowMarkers.length > 0) {
        candlestickSeries.setMarkers(flowMarkers);
    }

    // SMA 50 line series
    const sma50Series = priceChart.addLineSeries({
        color: '#ffaa00',
        lineWidth: 1,
        title: 'SMA 50',
        priceLineVisible: false,
        lastValueVisible: false,
    });
    if (indicatorData.sma_50) {
        const sma50Data = indicatorData.sma_50.filter(d => d.value !== null);
        sma50Series.setData(sma50Data);
    }

    // SMA 200 line series
    const sma200Series = priceChart.addLineSeries({
        color: '#00aaff',
        lineWidth: 1,
        title: 'SMA 200',
        priceLineVisible: false,
        lastValueVisible: false,
    });
    if (indicatorData.sma_200) {
        const sma200Data = indicatorData.sma_200.filter(d => d.value !== null);
        sma200Series.setData(sma200Data);
    }

    // Volume histogram series
    const volumeSeries = volumeChart.addHistogramSeries({
        color: '#26a69a',
        priceFormat: { type: 'volume' },
        priceScaleId: '',
    });
    const volumeData = chartData.map(d => ({
        time: d.time,
        value: d.volume,
        color: d.close >= d.open ? 'rgba(0, 200, 83, 0.5)' : 'rgba(255, 82, 82, 0.5)',
    }));
    volumeSeries.setData(volumeData);

    // Sync time scales
    priceChart.timeScale().subscribeVisibleTimeRangeChange((range) => {
        if (range) {
            volumeChart.timeScale().setVisibleRange(range);
        }
    });

    // Fit content
    priceChart.timeScale().fitContent();
    volumeChart.timeScale().fitContent();

    // Handle resize
    window.addEventListener('resize', () => {
        priceChart.applyOptions({ width: priceContainer.clientWidth });
        volumeChart.applyOptions({ width: volumeContainer.clientWidth });
    });

    // Toggle controls
    document.getElementById('toggle-sma50').addEventListener('change', (e) => {
        sma50Series.applyOptions({ visible: e.target.checked });
    });

    document.getElementById('toggle-sma200').addEventListener('change', (e) => {
        sma200Series.applyOptions({ visible: e.target.checked });
    });

    document.getElementById('toggle-volume').addEventListener('change', (e) => {
        volumeContainer.style.display = e.target.checked ? 'block' : 'none';
    });

    document.getElementById('toggle-markers').addEventListener('change', (e) => {
        if (e.target.checked && flowMarkers && flowMarkers.length > 0) {
            candlestickSeries.setMarkers(flowMarkers);
        } else {
            candlestickSeries.setMarkers([]);
        }
    });
</script>
{% endblock %}
