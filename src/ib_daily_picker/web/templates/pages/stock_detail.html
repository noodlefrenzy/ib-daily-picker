{% extends "base.html" %}

{% block title %}{{ symbol }} - IB Daily Picker{% endblock %}

{% block head_scripts %}
<!-- TradingView Lightweight Charts -->
<script src="/static/vendor/lightweight-charts.standalone.production.js"></script>
{% endblock %}

{% block content %}
<div class="stock-detail">
    <!-- Header -->
    <div class="stock-header">
        <div class="stock-title">
            <h1>{{ symbol }}</h1>
            {% if metadata and metadata.name %}
            <span class="stock-name">{{ metadata.name }}</span>
            {% endif %}
        </div>
        <div class="stock-actions">
            {% if in_watchlist %}
            <button class="btn btn-secondary"
                    hx-delete="/api/watchlist/{{ symbol }}"
                    hx-swap="outerHTML"
                    hx-target="closest button">
                Remove from Watchlist
            </button>
            {% else %}
            <button class="btn btn-primary"
                    hx-post="/api/watchlist"
                    hx-vals='{"symbol": "{{ symbol }}"}'
                    hx-swap="outerHTML"
                    hx-target="closest button">
                Add to Watchlist
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Stats Row -->
    <section class="card">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">${{ "%.2f"|format(stats.latest_close) }}</div>
                <div class="stat-label">Last Close</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ "{:,}".format(stats.volume) }}</div>
                <div class="stat-label">Volume</div>
            </div>
            {% if stats.high_52w %}
            <div class="stat-card">
                <div class="stat-value">${{ "%.2f"|format(stats.high_52w) }}</div>
                <div class="stat-label">52W High</div>
            </div>
            {% endif %}
            {% if stats.low_52w %}
            <div class="stat-card">
                <div class="stat-value">${{ "%.2f"|format(stats.low_52w) }}</div>
                <div class="stat-label">52W Low</div>
            </div>
            {% endif %}
            {% if metadata and metadata.sector %}
            <div class="stat-card">
                <div class="stat-value">{{ metadata.sector }}</div>
                <div class="stat-label">Sector</div>
            </div>
            {% endif %}
            <div class="stat-card">
                <div class="stat-value">{{ stats.data_points }}</div>
                <div class="stat-label">Data Points</div>
            </div>
        </div>
    </section>

    <!-- Chart -->
    <section class="card">
        <h2>Price Chart</h2>
        <div id="chart" style="height: 400px;"></div>
    </section>

    <!-- Flow Alerts -->
    {% if flow_alerts %}
    <section class="card">
        <h2>Flow Alerts ({{ flow_alerts|length }})</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Type</th>
                    <th>Direction</th>
                    <th>Premium</th>
                    <th>Strike</th>
                    <th>Expiration</th>
                    <th>Sentiment</th>
                </tr>
            </thead>
            <tbody>
                {% for alert in flow_alerts %}
                <tr>
                    <td class="timestamp">{{ alert.alert_time.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>{{ alert.alert_type.value }}</td>
                    <td class="{% if alert.direction.value == 'bullish' %}positive{% elif alert.direction.value == 'bearish' %}negative{% endif %}">
                        {{ alert.direction.value|upper }}
                    </td>
                    <td>{% if alert.premium %}${{ "{:,.0f}".format(alert.premium) }}{% else %}-{% endif %}</td>
                    <td>{% if alert.strike %}${{ "%.2f"|format(alert.strike) }}{% else %}-{% endif %}</td>
                    <td>{% if alert.expiration %}{{ alert.expiration }}{% else %}-{% endif %}</td>
                    <td class="{% if alert.sentiment.value == 'bullish' %}positive{% elif alert.sentiment.value == 'bearish' %}negative{% endif %}">
                        {{ alert.sentiment.value }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize chart
    const chartData = {{ chart_data | tojson }};

    const chartContainer = document.getElementById('chart');
    const chart = LightweightCharts.createChart(chartContainer, {
        width: chartContainer.clientWidth,
        height: 400,
        layout: {
            background: { type: 'solid', color: '#16213e' },
            textColor: '#e8e8e8',
        },
        grid: {
            vertLines: { color: '#2d2d44' },
            horzLines: { color: '#2d2d44' },
        },
        crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
        },
        rightPriceScale: {
            borderColor: '#2d2d44',
        },
        timeScale: {
            borderColor: '#2d2d44',
            timeVisible: true,
        },
    });

    const candlestickSeries = chart.addCandlestickSeries({
        upColor: '#00c853',
        downColor: '#ff5252',
        borderDownColor: '#ff5252',
        borderUpColor: '#00c853',
        wickDownColor: '#ff5252',
        wickUpColor: '#00c853',
    });

    candlestickSeries.setData(chartData);

    // Fit content
    chart.timeScale().fitContent();

    // Handle resize
    window.addEventListener('resize', () => {
        chart.applyOptions({ width: chartContainer.clientWidth });
    });
</script>
{% endblock %}
